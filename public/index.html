<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- alpine.js -->
    <script defer src="alpine-v3.12.0.js"></script>
    <!-- css -->
    <link rel="stylesheet" href="index.css" />
    <title>音频工具箱 Audio Tools by Vincent</title>
</head>

<body>
    <script src="detect.js"></script>
    <script>
        // store
        document.addEventListener('alpine:init', () => {
            Alpine.store('languageStore', {
                currentLang: "zh",
            })
        })
        // get current OS
        function useCurrentPlatform() {
            const agent = navigator.userAgent.toLowerCase();
            const isMac = /macintosh|mac os x/i.test(navigator.userAgent);
            if (agent.indexOf("win32") >= 0 || agent.indexOf("wow32") >= 0) {
                return "win32"
            }
            if (agent.indexOf("win64") >= 0 || agent.indexOf("wow64") >= 0) {
                return "win64"
            }
            if (isMac) {
                return "mac"
            }
            else {
                return "linux"
            }
        }

        // init directorys
        function getNcmDir(){
            const platform = useCurrentPlatform()
            if(localStorage.getItem("ncmDir")) return localStorage.getItem("ncmDir")
            else{
                if(platform === "win32" || platform === "win64"){
                    return `C:\\Users\\Public\\ncm`
                }
                else return `/Users/Shared/ncm` 
            }
        }

        function getMp3OutDir(){
            const platform = useCurrentPlatform()
            if(localStorage.getItem("mp3OutDir")) return localStorage.getItem("mp3OutDir")
            else{
                if(platform === "win32" || platform === "win64"){
                    return `C:\\Users\\Public\\mp3`
                }
                else return `/Users/Shared/mp3` 
            } 
        }

        function getSongCoverOutDir(){
            const platform = useCurrentPlatform()
            if(localStorage.getItem("songCoverOutDir")) return localStorage.getItem("songCoverOutDir")
            else{
                if(platform === "win32" || platform === "win64"){
                    return `C:\\Users\\Public\\songcover`
                }
                else return `/Users/Shared/songcover` 
            }
        }

    </script>
    <script>
        // Data component
        function Data() {
            return {
                mp3FileName: "",
                message: () => Alpine.store('languageStore').currentLang === 'zh' ? "↑ 点击" : "↑ Click",
                ncmDir: getNcmDir(),
                mp3OutDir: getMp3OutDir(),
                songCoverOutDir: getSongCoverOutDir(),
                bpm: 0,
                files: [],
                // Lifecycle: init
                // initial MP3 files
                init() {
                   this.loadMp3Files()
                },
                loadMp3Files(){
                    fetch(
                        `http://127.0.0.1:8080/readFiles?mp3Dir=${this.mp3OutDir}&ncmDir=${this.ncmDir}&songCoverDir=${this.songCoverOutDir}`
                    ).then(async response => {
                        const result = await response.json()
                        this.files = result.files
                        this.mp3FileName = this.files[0]
                    }).catch(err => {
                        this.message = Alpine.store('languageStore').currentLang === 'zh' ?
                        "ncm2mp3方法请求错误" : 
                        "ncm2mp3 Request Error!"
                        setTimeout(() => {
                            this.message = Alpine.store('languageStore').currentLang === 'zh' ? "↑ 点击" : "↑ Click"
                        }, 2000)
                    })
                },
                customNcm2mp3() {
                    fetch("http://127.0.0.1:8080/customNcm2mp3", {
                        method: 'post',
                        body: JSON.stringify({
                            ncmDir: this.ncmDir,
                            mp3OutDir: this.mp3OutDir,
                            songCoverOutDir: this.songCoverOutDir
                        }),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(async response => {
                        const result = await response.json()
                        if (result.code === 500) {
                            this.message = result.err
                        }
                        else {
                            localStorage.setItem("ncmDir",this.ncmDir)
                            localStorage.setItem("mp3OutDir", this.mp3OutDir)
                            localStorage.setItem("songCoverOutDir", this.songCoverOutDir)
                            this.message = Alpine.store('languageStore').currentLang === 'zh' ?
                                            result.msgZh : 
                                            result.msgEn
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000)
                        }
                        setTimeout(() => {
                            this.message = Alpine.store('languageStore').currentLang === 'zh' ? "↑ 点击" : "↑ Click"
                        }, 2000)
                    }).catch(err => {
                        Alpine.store('languageStore').currentLang === 'zh' ?
                        alert("ncm2mp3方法请求错误") : 
                        alert("ncm2mp3 Request Error!")
                    })
                },
                calcBPM() {
                    const AudioContext = window.AudioContext || window.webkitAudioContext
                    const context = new AudioContext()
                    // Fetch audio file
                    fetch(`http://127.0.0.1:8080/getMp3File?filePath=${this.mp3OutDir}/${this.mp3FileName}`).then(async (response) => {
                        // Get response as ArrayBuffer
                        const buffer = await response.arrayBuffer()

                        // Decode audio into an AudioBuffer
                        const data = await new Promise(function (resolve, reject) {
                            context.decodeAudioData(buffer, resolve, reject)
                        });

                        // Run detection
                        this.bpm = detect(data) * 1
                    }).catch(console.error)
                }
            }
        }

    </script>

    <header x-data="Data">
        <p align="left">
        <h1>Audio Tools</h1>
        </p>
        <p align="right">
            <span>Language:</span>
            <select x-model="$store.languageStore.currentLang">
                <option value="zh">简体中文</option>
                <option value="en">English</option>
            </select>
            <a href="https://github.com/Vincent-the-gamer/audio-tools" target="_blank">GitHub</a>
        </p>
    </header>
    <div class="container" x-data="Data">
        <template x-if="$store.languageStore.currentLang === 'zh'">
            <h1>ncm转mp3</h1>
        </template>
        <template x-if="$store.languageStore.currentLang === 'en'">
            <h1>ncm to mp3</h1>
        </template>
        <template x-if="$store.languageStore.currentLang === 'zh'">
            <h2>将.ncm后缀文件放入ncm文件夹，然后点击以下按钮即可批量转mp3</h2>
        </template>
        <template x-if="$store.languageStore.currentLang === 'en'">
            <h2>Put .ncm files into ncm folder, then click the button</h2>
        </template>
        <p align="center">
            <template x-if="$store.languageStore.currentLang === 'zh'">
                <p>
                    ncm输入路径:
                    <input type="text" x-model="ncmDir"/>
                </p>
                <br />
            </template>
            <template x-if="$store.languageStore.currentLang === 'zh'">
                <p>
                    mp3输出路径:
                    <input type="text" x-model="mp3OutDir" />
                </p>
                <br />
            </template>
            <template x-if="$store.languageStore.currentLang === 'zh'">
                <p>
                    歌曲封面输出路径:
                    <input type="text" x-model="songCoverOutDir" />
                </p>
                <br />
            </template>
            <template x-if="$store.languageStore.currentLang === 'zh'">
                <button @click="customNcm2mp3">批量转mp3</button>
            </template>
            <template x-if="$store.languageStore.currentLang === 'en'">
                <p>
                    ncm input directory:
                    <input type="text" x-model="ncmDir" />
                </p>
                <br />
            </template>
            <template x-if="$store.languageStore.currentLang === 'en'">
                <p>
                    mp3 output directory:
                    <input type="text" x-model="mp3OutDir" />
                </p>
                <br />
            </template>
            <template x-if="$store.languageStore.currentLang === 'en'">
                <p>
                    songcover output directory:
                    <input type="text" x-model="songCoverOutDir"/>
                </p>
                <br />
            </template>
            <template x-if="$store.languageStore.currentLang === 'en'">
                <button @click="customNcm2mp3">Convert All</button>
            </template>

        </p>
        <h3 x-text="message"></h3>
        <hr>
        <template x-if="$store.languageStore.currentLang === 'zh'">
            <h1>计算BPM</h1>
        </template>
        <template x-if="$store.languageStore.currentLang === 'en'">
            <h1>Calculate BPM</h1>
        </template>

        <template x-if="$store.languageStore.currentLang === 'zh'">
            <h2>选择文件夹里面已有的mp3文件 (xxx.mp3), 计算BPM</h2>
        </template>
        <template x-if="$store.languageStore.currentLang === 'en'">
            <h2>Choose existing mp3 file (xxx.mp3) in public/mp3 folder to calculate BPM</h2>
        </template>

        <p align="center">
            <template x-if="files.length > 0">
                <select x-model="mp3FileName">
                    <template x-for="item of files">
                        <option x-text="item" :value="item"></option>
                    </template>
                </select>
            </template>

            <template x-if="files.length <= 0">
                <select class="select-bpm">
                    <template x-if="$store.languageStore.currentLang === 'zh'">
                        <option value="">没有待检测bpm的mp3文件</option>
                    </template>
                    <template x-if="$store.languageStore.currentLang === 'en'">
                        <option value="">No mp3 file in your mp3 folder.</option>
                    </template>
                </select>
            </template>
            <template x-if="$store.languageStore.currentLang === 'zh'">
                <button @click="calcBPM">计算BPM</button>
            </template>
            <template x-if="$store.languageStore.currentLang === 'zh'">
                <button @click="loadMp3Files">刷新</button>
            </template>

            <template x-if="$store.languageStore.currentLang === 'en'">
                <button @click="calcBPM" id="eng-bpm">Calculate BPM</button>
            </template>
            <template x-if="$store.languageStore.currentLang === 'en'">
                <button @click="loadMp3Files">Refresh</button>
            </template>
        <h3 x-text="['BPM: ' + bpm]"></h3>
        </p>
    </div>

    <footer>
        <h3>@2023 Vincent-the-gamer | MIT Licensed</h3>
    </footer>


</body>

</html>