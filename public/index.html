<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- alpine.js -->
    <script defer src="alpine-v3.12.0.js"></script>
    <!-- css -->
    <link rel="stylesheet" href="index.css"/>
    <title>音频工具箱</title>
</head>

<body>
    <script src="detect.js"></script>
    <!-- store -->
    <script>
    document.addEventListener('alpine:init', () => {
        Alpine.store('languageStore', {
            currentLang: "zh",
        })
    })
    </script>
    <script>
        // Data组件
        function Data() {
            return {
                mp3FileName: "",
                message: "↑ Click",
                bpm: 0,
                files: [],
                // 生命周期钩子: 挂载
                init(){
                    fetch("http://localhost:8080/readFiles").then(async response => {
                        const result = await response.json()
                        this.files = result.files
                        this.mp3FileName = this.files[0]
                    }).catch(err => {
                        alert("MP3 Request Error!!")
                    })
                },
                ncm2mp3() {
                    fetch("http://localhost:8080/ncm2mp3").then(async response => {
                        const result = await response.json()
                        if(result.code === 500){
                            this.message = result.err
                        }
                        else{
                            this.message = result.msg
                        }
                        setTimeout(() => {
                            this.message = "↑ Click"
                        }, 2000)
                    }).catch(err => {
                        this.message = "ncm2mp3 Request Error!"
                    })
                },
                calcBPM() {
                    const AudioContext = window.AudioContext || window.webkitAudioContext
                    const context = new AudioContext()
                    // Fetch some audio file
                    fetch(`http://localhost:8080/mp3/${this.mp3FileName}`).then(async (response) => {
                        // Get response as ArrayBuffer
                        const buffer = await response.arrayBuffer()

                        // Decode audio into an AudioBuffer
                        const data = await new Promise(function (resolve, reject) {
                            context.decodeAudioData(buffer, resolve, reject)
                        });

                        // Run detection
                        this.bpm = detect(data) * 1
                    }).catch(console.error)
                }
            }
        }
    </script>

    <header x-data="Data">
        <p align="left">
            <h1>Audio Tools</h1>
        </p>
        <p align="right">
            <span>Language:</span> 
            <select x-model="$store.languageStore.currentLang">
                <option value="zh">简体中文</option>
                <option value="en">English</option>
            </select>
            <a href="https://github.com/Vincent-the-gamer/audio-tools" 
               target="_blank">GitHub</a>
        </p>
    </header>
    <div class="container" x-data="Data">
        <template x-if="$store.languageStore.currentLang === 'zh'">
            <h1>ncm转mp3</h1>
        </template>
        <template x-if="$store.languageStore.currentLang === 'en'">
            <h1>ncm to mp3</h1>
        </template>
        <template x-if="$store.languageStore.currentLang === 'zh'">
            <h2>将.ncm后缀文件放入ncm文件夹，然后点击以下按钮即可批量转mp3</h2>
        </template>
        <template x-if="$store.languageStore.currentLang === 'en'">
            <h2>Put .ncm files into ncm folder, then click the button</h2>
        </template>
       <p align="center">
         <template x-if="$store.languageStore.currentLang === 'zh'">
            <button @click="ncm2mp3">批量转mp3</button>
         </template>
         <template x-if="$store.languageStore.currentLang === 'en'">
            <button @click="ncm2mp3">Convert All</button>
         </template>

       </p>
       <h3 x-text="message"></h3>
       <hr>
       <template x-if="$store.languageStore.currentLang === 'zh'">
         <h1>计算BPM</h1>
       </template>
       <template x-if="$store.languageStore.currentLang === 'en'">
         <h1>Calculate BPM</h1>
       </template>
      
       <template x-if="$store.languageStore.currentLang === 'zh'">
         <h2>选择文件夹里面已有的mp3文件 (xxx.mp3), 计算BPM</h2>
       </template>
       <template x-if="$store.languageStore.currentLang === 'en'">
         <h2>Choose existing mp3 file (xxx.mp3) in public/mp3 folder to calculate BPM</h2>
       </template>
       
       <p align="center">
            <template x-if="files.length > 0">
                <select x-model="mp3FileName">
                    <template x-for="item of files">
                        <option x-text="item" :value="item"></option>
                    </template>
                </select>
            </template>
           
            <template x-if="files.length <= 0">
                <select class="select-bpm">
                    <template x-if="$store.languageStore.currentLang === 'zh'">
                        <option value="">没有待检测bpm的mp3文件</option>
                    </template>
                    <template x-if="$store.languageStore.currentLang === 'en'">
                        <option value="">No mp3 file in public/mp3 folder.</option>
                    </template>
                </select>
            </template>
            <template x-if="$store.languageStore.currentLang === 'zh'">
                <button @click="calcBPM">计算BPM</button>
            </template>
            <template x-if="$store.languageStore.currentLang === 'en'">
                <button @click="calcBPM">Calculate BPM</button>
            </template>
            <h3 x-text="['BPM: ' + bpm]"></h3>
       </p>
    </div>

    <footer>
        <h3>@2023 Vincent-the-gamer | MIT Licensed</h3>
    </footer>


</body>

</html>